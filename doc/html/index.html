<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>dataclient-dht22: DATACLIENT-DHT22</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">dataclient-dht22
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generato da Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Cerca');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Cerca');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">DATACLIENT-DHT22 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><img src="doc/assets/dataclient.svg" alt="" class="inline"/> </p><h1>Introduzione</h1>
<p>Questo Sketch arduino si occupa di inviare i dati recuperati dal dht22 al raspberry via MQTT.</p>
<h1>Sezioni</h1>
<ul>
<li><a href="#guida-alluso">Guida all'uso</a></li>
<li><a href="#descrizione">Descrizione</a></li>
<li><a href="#dettagli-funzioni">Dettagli funzioni</a></li>
<li><a href="#requisiti">Requisiti</a></li>
<li><a href="#changelog">Changelog</a></li>
<li><a href="#sviluppo">Sviluppo</a></li>
</ul>
<h1>Guida all'uso</h1>
<p>Personalizzare, se necessario, il valore delle seguenti variabili:</p><ul>
<li>DHTPIN: pin dato del DHT22 <blockquote class="doxtable">
<p>NOTA: il numero pin nello sketch e il numero sulla scheda non corrispondono </p>
</blockquote>
</li>
<li>mqttServer: stringa contenente IP/dominio del broker MQTT</li>
<li>mqttPort: porta in ascolto del broker MQTT</li>
<li>mqttUser: utente broker MQTT</li>
<li>mqttPassword: password di mqttUser</li>
<li>timeToWait: tempo tra le letture</li>
<li>WIFI_SSID: SSID access point WiFi</li>
<li>WIFI_PASS: password access point WiFi</li>
</ul>
<blockquote class="doxtable">
<p>I valori di default delle altre variabili sono adatti all'uso previsto nel progetto201 e la loro modifica puo' portare alla modifica di altri script. </p>
</blockquote>
<p>Preparare il computer all'interfacciamento con Node MCU:</p><ol type="1">
<li>Installare il driver da <a href="https://www.silabs.com/products/mcu/Pages/USBtoUARTBridgeVCPDrivers.aspx">questa pagina</a> <blockquote class="doxtable">
<p>Per altre schede installare il relativo driver </p>
</blockquote>
</li>
</ol>
<p>Preparare l'arduino IDE per caricare sketch su Node MCU:</p><ol type="1">
<li>Andare in <code>File --&gt; Impostazioni</code> (CTRL + virgola)</li>
<li>In "URL aggiuntive per il Gestore schede" inserire l'URL <div class="fragment"><div class="line">http://arduino.esp8266.com/stable/package_esp8266com_index.json</div>
</div><!-- fragment --></li>
<li>Chiudere e riaprire l'Arduino IDE per fargli scaricare le informazioni relative alle schede esp8266</li>
<li>Andare in <code>Strumenti --&gt; Scheda: ... --&gt; Gestore schede</code></li>
<li>Cercare e installare <code>esp8266 by ESP8266 Community</code></li>
<li>Scegliere le impostazioni adatte a caricare sketch su NodeMCU:<ul>
<li>Scheda: NodeMCU (o generic esp8266 module)</li>
<li>Flash Mode: QIO</li>
<li>Flash Frequency: 40 MHZ</li>
<li>CPU Frequency: 80 MHZ</li>
<li>Flash Size: 4M 1M SPIFFS</li>
<li>Reset Method: nodemcu</li>
<li>Upload Speed: 115200 <blockquote class="doxtable">
<p>Per altre schede attenersi al procedimento consigliato dal produttore </p>
</blockquote>
</li>
</ul>
</li>
</ol>
<p>Installare le librerie usate da questo sketch:</p><ol type="1">
<li>Andare in <code>Sketch --&gt; #Include libreria --&gt; Gestione librerie</code></li>
<li>Cercare e installare la libreria <code>ArduinoJson by Benoit Blanchon</code> per gestire oggetti JSON</li>
<li>Cercare e installare la libreria <code>Adafruit Unified Sensor by Adafruit</code>, libreria necessaria per le altre librerie di sensori di Adafruit</li>
<li>Cercare e installare la libreria <code>DHT sensor library by Adafruit</code> per gestire il DHT22</li>
<li>Cercare e installare la libreria <code>PubSubClient by Nick O'Leary</code> per connettersi e inviare messaggi al broker MQTT</li>
</ol>
<p>Selezionare da <code>Strumenti</code> la porta a cui e' connessa la scheda e premere il pulsante <code>Carica</code> per caricare lo sketch.</p>
<h1>Descrizione</h1>
<p><img src="doc/assets/setup_loop.svg" alt="" class="inline"/></p>
<p>Come in tutti gli sketch arduino vengono definiti variabili e oggetti, poi viene richiamata una volta la funzione <code>setup()</code> e infine viene richiamata "all'infinito" la funzione <code>loop()</code></p>
<p><img src="doc/assets/setup.svg" alt="" class="inline"/></p>
<p>La funzione <code>setup()</code> richiama la funzione <code>macAddrToString()</code> per definire nella variabile stringa <code>&lt;macAddr&gt;</code> l'indirizzo MAC. La funzione poi si assicura che <code>&lt;timeToWait&gt;</code>, il tempo interposto tra le rilevazioni, sia un numero accettabile (&gt;= 2000 [ms]) </p><blockquote class="doxtable">
<p>Altrimenti viene impostato 2000 come valore di default (2 secondi tra lettura) </p>
</blockquote>
<p><img src="doc/assets/loop.svg" alt="" class="inline"/></p>
<p>La funzione <code>loop()</code> mantiene la scheda connessa all'access point di raspberry (con la funzione <code>WiFiconn()</code>) e al broker MQTT (con la funzione <code>MQTTconn()</code> e il metodo <code>client.loop()</code>). Se la scheda e' connessa a WiFi e broker MQTT si verifica se e' stato atteso il tempo <code>&lt;timeToWait&gt;</code>: se e' cos√¨ viene rilevata temperatura e umidita' e memorizzato l'RSSI.</p>
<p>Lo sketch, dopo essersi assicurato che le rilevazioni hanno avuto successo, utilizza la funzione <code>reportData()</code> per inviare i dati al broker MQTT.</p>
<p>Per la documentazione dettagliata del codice (creata da doxygen) visitare <a href="doc/html/index.html">questa pagina</a></p>
<h2>Dettagli funzioni</h2>
<pre class="fragment">macAddrToString()
</pre><p> Scorre l'array di byte restituito da <code>WiFi.macAddress()</code>, concatena come stringa i byte e la salva in <code>&lt;macAddr&gt;</code> </p><pre class="fragment">WiFiconn()
</pre><p> Si connette al WiFi e salva nella stringa <code>&lt;ipAddr&gt;</code> l'indirizzo IP </p><pre class="fragment">MQTTconn()
</pre><p> Si connette al broker MQTT e richiama la funzione <code>present()</code> </p><pre class="fragment">present()
</pre><p> Invia al broker MQTT indirizzi IP e MAC, tipo di nodo e <code>&lt;timeToWait&gt;</code> in formato JSON </p><pre class="fragment">reportData()
</pre><p> Invia al broker MQTT i dati rilevati dal sensore e l'RSSI in formato JSON</p>
<h1>Requisiti</h1>
<ul>
<li>Arduino IDE con schede e librerie installate</li>
</ul>
<h1>Changelog</h1>
<p><b>2020-02-18 01_01</b>:</p>
<p>Prima versione</p>
<h1>Sviluppo</h1>
<p>Modificare il valore di queste due variabili:</p><ul>
<li>dhtConnected: impostare false se il DHT22 non e' connesso <blockquote class="doxtable">
<p>NOTA: questa variabile in produzione DEVE essere impostata a true per rilevare la temperatura dal DHT22. Puo' essere utile impostare false durante fasi di test in cui non si ha necessita' del sensore. </p>
</blockquote>
</li>
<li>serialDebug: impostare true per visualizzare messaggi sul serial monitor <blockquote class="doxtable">
<p>NOTA: questa variabile in produzione DOVREBBE essere impostata a false: uno dei motivi e' la visualizzazione della password WiFi in caso di insuccesso durante la connessione </p>
</blockquote>
</li>
</ul>
<h1>Autore</h1>
<p>Stefano Zenaro (<a href="https://github.com/mario33881">Github</a>) </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generato da &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
